---
author:
date: 2024-09-01 17:43:00 +0800
---

#  <center>流量计设计资料</center>

> - [ ] Revsion V1.5
> - [ ] 日期：25.04.11

## 1. 标定操作

### 1.1 手动标定操作

前3位标定选项值，后3位进入标定口令，固定为 235。

>电阻标定与小数点无关，程序固定 2 位小数，流量计单位小数点自动处理。

#### 1.1.1 长按 M 键进入 6 位密码模式，各位含义如下

- 第 1 位：标定类型
  - 0：压力
  - 1：电阻[Ω]
  - 2：压差
  - 3：高度[m]
  - 4：流量[m³/h]

- 第 2 位：小数点，取值 [3,4,5]
- 第 3 位：单位（标定类型为压力时）
  - 0：Mpa
  - 1：Kpa

#### 1.1.2 短按 M 键可查看历史标定参数，若需修改

- 按 S 键，光标闪烁时可按 S 键移动光标，J 键调整。
- 按 M 键保存，长按 M 键退出标定模式。
- 光标闪烁时若不修改，长按 S 键退出标定模式，按 M键退出会保存单位和小数点。

#### 1.1.3 流量计手动标定

> 输入密码 400235，数据宽度 8 位为浮点输入，格式为自左向右 1 位符号位（S）、1 位小数点位（D）、6 位数值位（XXXXXX）。符号位判断：0 为正数，非 0 为负数。

#### 1.1.4 标定参数列表

| 序号 | 名称 | 格式 | 单位 | 说明 |
| ---- | ---- | ---- | ---- | ---- |
| 0 | 频率分段点数 | SDXXXXXX |  |  |
| 1 | 仪表计算系数 a | SDXXXXXX |  |$k=af^4+bf^3+cf^2+df+e$|
| 2 | 仪表计算系数 b | SDXXXXXX |  |  |
| 3 | 仪表计算系数 c | SDXXXXXX |  |  |
| 4 | 仪表计算系数 d | SDXXXXXX |  |  |
| 5 | 仪表计算系数 e | SDXXXXXX |  |  |
| 6 | 仪表系数 | SDXXXXXX | p/L |  |
| 7 | 参考 DN | SDXXXXXX | mm |  |
| 8 | 参考 MaxQ | SDXXXXXX | m³/h |  |
| 9 | 仪表运行系数选项 | 0000000X |  | [0: 频率分段系数区间值, 3: 频率分段系数插值，1: 频率计算系数，2: 平均系数] |
| 10 | 频率输出选择 | 0000000X |  | 校准后: 0，原始频率: 1 |
| ---| --- | --- | --- |--- |
| 11| 频率点 0 值 | SDXXXXXX | Hz（精度 0.1Hz） | 频率 <= 频率点 0 的值，取频率点 0 的系数 |
| 12 | 频率点 0 系数 | SDXXXXXX |  |  |
| 13 | 频率点 1 值 | SDXXXXXX |  | 频率点 0 的值 < 频率 <= 频率点 1 的值，取频率点 1 的系数 |
| 14 | 频率点 1 系数 | SDXXXXXX |  |  |
| 15 | 频率点 2 值 | SDXXXXXX |  |  |
| 16 | 频率点 2 系数 | SDXXXXXX |  |  |
| 17 | 频率点 3 值 | SDXXXXXX |  |  |
| 18 | 频率点 3 系数 | SDXXXXXX |  |  |
| 19 | 频率点 4 值 | SDXXXXXX |  |  |
| 20 | 频率点 4 系数 | SDXXXXXX |  |  |
| 21 | 频率点 5 值 | SDXXXXXX |  |  |
| 22 | 频率点 5 系数 | SDXXXXXX |  |  |
| 23 | 频率点 6 值 | SDXXXXXX |  |  |
| 24 | 频率点 6 系数 | SDXXXXXX |  |  |
| 25 | 频率点 7 值 | SDXXXXXX |  |  |
| 26 | 频率点 7 系数 | SDXXXXXX |  |  |
| 27 | 频率点 8 值 | SDXXXXXX |  |  |
| 28 | 频率点 8 系数 | SDXXXXXX |  |  |
| 29 | 频率点 9 值 | SDXXXXXX |  |  |
| 30 | 频率点 9 系数 | SDXXXXXX |  |  |
| 31 | 频率点 10 值 | SDXXXXXX |  |  |
| 32 | 频率点 10 系数 | SDXXXXXX |  |  |
| 33 | 频率点 11 值 | SDXXXXXX |  |  |
| 34 | 频率点 11 系数 | SDXXXXXX |  |  |
| 35 | 频率点 12 值 | SDXXXXXX |  |  |
| 36 | 频率点 12 系数 | SDXXXXXX |  |  |
| 37 | 频率点 13 值 | SDXXXXXX |  |  |
| 38 | 频率点 13 系数 | SDXXXXXX |  |  |
| 39 | 频率点 14 值 | SDXXXXXX |  |  |
| 40 | 频率点 14 系数 | SDXXXXXX |  |  |
| 41 | 频率点 15 值 | SDXXXXXX |  |  |
| 42 | 频率点 15 系数 | SDXXXXXX |  |  |
| 43 | 频率点 16 值 | SDXXXXXX |  |  |
| 44 | 频率点 16 系数 | SDXXXXXX |  |  |
| 45 | 频率点 17 值 | SDXXXXXX |  |  |
| 46 | 频率点 17 系数 | SDXXXXXX |  |  |
| 47 | 频率点 18 值 | SDXXXXXX |  |  |
| 48 | 频率点 18 系数 | SDXXXXXX |  |  |
| 49 | 频率点 19 值 | SDXXXXXX |  |  |
| 50 | 频率点 19 系数 | SDXXXXXX |  |  |

### 1.2 modbus标定协议

 > ==无特殊申明以下数据类型为整形大端，浮点数则为 IEEE754，数据均为 16 进制。==

##### 1.2.1 读当前通道脉冲累计值

- **写请求**：`addr 03H 30 10 00 02 2byte(crc)`
- **响应**：`addr 03H 04 4byte脉冲累计值 2byte(crc) XXXXXXXXXX`

##### 1.2.2 读当前通道瞬时频率值

当前通道瞬时频率值为 1 位定点小数，是 10S 滑动平均值。

- **写请求**：`addr 03H 30 11 00 01 2byte(crc)`
- **响应**：`addr 03H 02 2byte瞬时频率值 2byte(crc) XXXX.X`

##### 1.2.3 写频率分段参数

写频率的分段点数，频率分段点和对应的仪表系数，频率值为 1 位定点小数，频率分段数最多 20 个。

- **写请求**：`addr 11H 30 01 00 xx len 2B频率分段数,分段点0对应2B频率值&4B(float)仪表系数…2byte(crc)`
- **响应**：`addr 11H 30 01 00 xx  2byte(crc)`

##### 1.2.4 写频率计算仪表系数多项式参数

频率计算仪表系数多项式为 $k(x)=ax^4+bx^3+cx^2+dx^1+e$，$x$ 为频率，1 位定点小数。

- **写请求**：`addr 11H 30 02 00 0A 14H 4B(float)参数a…4B(float)参数e 2byte(crc)`
- **响应**：`addr 11H 30 02 00 xx  2byte(crc)`

##### 1.2.5 写仪表平均系数

- **写请求**：`addr 11H 30 03 00 02 04 4B(float)仪表系数 2byte(crc)`
- **响应**：`addr 11H 30 03 00 xx  2byte(crc)`

##### 1.2.6 写仪表系数算法寄存器

算法选择值：[分段：0，频率计算：1，平均系数：2，插值计算:3]

- **写请求**：`addr 11H 30 04 00 01 02 2B算法值 2byte(crc)`
- **响应**：`addr 11H 30 04 00 xx  2byte(crc)`

##### 1.2.7 写最大参考流量

最大参考流量用于内部参考计算，单位 0.1m^3^/h。

- **写请求**：`addr 11H 30 05 00 01 02 2B最大参考流量 2byte(crc)`
- **响应**：`addr 11H 30 05 00 xx  2byte(crc)`

##### 1.2.8 写仪表口径

仪表口径单位为 XXXX.Xmm。

- **写请求**：`addr 11H 30 06 00 01 02 2byte仪表口径 2byte(crc)`
- **响应**：`addr 11H 30 06 00 xx  2byte(crc)`

##### 1.2.9 写频率选择

频率选择值：[0：补偿后频率，1：原始频率]

- **写请求**：`addr 11H 30 07 00 01 02 2byte频率选择 2byte(crc)`
- **响应**：`addr 11H 30 07 00 xx  2byte(crc)`

## 2. 厂商参数设置

> 前3位口令固定为 327，后 3 位输入口令 237。

| opt | param | 数据输入格式 | 说明 |
| ---- | ---- | ---- | ---- |
| 0 | 流量系数 | XX.XXXX |  |
| 1 | 电流系数 | XX.XXXX |  |
| 2 | pt 温度修正 | XX.XXXX |  |
| 3 | 压力修正 | XX.XXXX |  |
| 4 | 定位功能 | XXXXXX | 无定位: 0, GPS: 1, LBS: 2 |
| 5 | 小信号切除(频率) | XXXXX.X | hz |
| 6 | 平均流量滤波时间 | XXXXXX |取值[0-9],实际表示[1-10]秒<br />推荐值[0，1，4，9] |
| 7 |电流2点校准的4mA实际输出值|`XXX.XXX`|参数修改时切换至理论4mA输出|
| 8 |电流2点校准的20mA实际输出值| `XXX.XXX` |参数修改时切换至理论20mA输出|

## 3. 用户参数设置

> 前 3 位口令固定为 111，后 3 位输入口令 237。

| opt | param | 数据输入格式 | 说明 |
| ---- | ---- | ---- | ---- |
| 0 | 单位选择 |  | (0: m³/h, 1: L/m, 2: Kg/h, 3: L/h, 4: T/h, 5: Kg/m, 6: m³/m, 7: T/m) |
| 1 | 电流下限 |  | 4 毫安对应流量值，单位 m³/h |
| 2 | 电流上限 |  | 20 毫安对应流量值，单位 m³/h |
| 3 | 电流方向 |  | 正向输出: 0, 反向输出：非 0 |
| 4 | 当量脉冲 | XXX.XXX | 单位: L |
| 5 | 脉冲宽度 | XXXXX.X | 单位: ms <= 1000.0ms |
| 6 | 密度值 | XXXX.XX | kg/m³ |
| 7 | RS485 站号 | XXXXXX |  |
| 8 | 波特率 | XXXXXX | 1200: 0, 2400: 1, 4800: 2, 9600: 3, 19200: 4 |
| 9 | Lora 频段 | XXXXXX | 485000kHz |
| 10 | Lora 网络地址 |  |  |
| 11 | Lora 节点高 16 位地址 |  |  |
| 12 | Lora 节点低 16 位地址 |  |  |
| 13 | CAT IP 地址高位 |  |  |
| 14 | CAT IP 地址低位 |  |  |
| 15 | CAT 端口 |  |  |
| 16 | CAT 发送间隔 |  | min |
| 17 | 系统日期 | XX.XX.XX | YYMMDD |
| 18 | 系统时间 | XX.XX.XX | HHMMSS |

## 4.用户高级参数设置（累计量设置）

> 前3位口令固定为 000，后3位输入口令，固定为 357。

| opt | param | 数据输入格式 | 说明 |
| ---- | ---- | ---- | ---- |
| 0 | total.int | XXXXXXXXX | 整数部分 m³ |
| 1 | total.dec | 000.XXXXXX | 小数部分 m³ |

## 5. 用户MODBUS-RTU协议

### 5.1 协议说明

- 所有浮点数的解析按照 ABCD 的顺序进行解析。
- 所有浮点类型占 2 寄存器，32位整数占 2 个寄存器。
- 数据类型为32位的，须用10H连续写入2个寄存器，10H只支持完整的一个数据写入。

### 5.2 寄存器地址说明

| 地址 | 功能说明 | 类型 | 意义 | 读写操作 |
| ---- | ---- | ---- | ---- | ---- |
| 0x00 | 温度 | 浮点数 |  | R |
| 0x02 | 瞬时流量 | 浮点数 | 单位参考瞬时流量单位 | R |
| 0x04 | 流速 m/s | 浮点数 |  | R |
| 0X06 | 频率 | 浮点数 |  | R |
| 0X08 | 累计流量整数部分 | 32位整数 |  | R |
| 0X0A | 累计流量小数部分 | 32位整数 | 6位定点小数累计流量＝小数部分 * 0.000001；累计单位：m³ | R |
| 0X0C | 瞬时流量单位 | 浮点数 | (0: m³/h, 1: L/min, 2: Kg/h, 3: L/h, 4: T/h, 5: Kg/min, 6: m³/min, 7: t/min) | R |
| 0X0E | 读取压力 | 浮点数 | 单位 Kpa | R |
| 0x10 | 读取标况流量 | 浮点数 | m³/h | R |
| 0x12 | 读取累计标况整数 | 32位整数 |  | R |
| 0x14 | 读取累计标况小数 | 32位整数 | 6位定点小数累计流量＝小数部分 * 0.000001；累计单位：m³ | R |
| 0X16 | 电流下限 | 浮点数 | 4毫安对应流量值，单位：m³/h | WR |
| 0X18 | 电流上限 | 浮点数 | 20 毫安对应流量值，单位：m³/h | WR |
| 0X20 | 密度值 | 32位整数 | 0.01kg/m³； 水：输入 100000 | WR |
| 0x22 | 脉冲当量 | 32位整数 | 单位: 0.001L | WR |
|--- | ----|以下16位寄存器|----|----|
| 0X2d | 触发理论4/20ma交替输出时长值 | 16位整数 | 间隔4秒交替，单位为秒，最长60秒 | rw |
| 0X2e | 实际4ma输出值 | 16位整数 | 单位0.001ma | rw |
| 0X2f | 实际20ma输出值 | 16位整数 | 单位0.001ma | rw |
| 0X30 | 流量累计清零 | 16位整数 | 写 0000 会清零累积流量数值 | WR |
| 0X31 | 流量单位设置 | 16位整数 | (0: m³/h, 1: L/min, 2: Kg/h, 3: L/h, 4: T/h, 5: Kg/min, 6: m³/min, 7: t/min) | WR |
| 0X32 | 电流方向 | 16位整数 | 0：正输出； 非 0: 反向输出 | WR |
| 0X33 | 脉冲宽度 | 16位整数 | 单位: 0.1ms   <=1000.0ms | WR |
| 0X34 | 485 地址 | 16位整数 | 01 - FF | WR |
| 0X35 | 波特率 | 16位整数 | 0: 1200, 1: 2400, 2: 4800, 3: 9600 | WR |
| 0X36 | 流量系数 | 16位整数 |4位定点小数 | WR |
| 0X37 | 电流系数 | 16位整数 |4位定点小数 | WR |
| 0X38 | 温度修正 | 16位整数 |4位定点小数 | WR |
| 0X39 | 压力修正 | 16位整数 |4位定点小数 | WR |
| 0X40 | 小信号切除频率 | 整数 | 单位：0.1HZ | WR |
| 0X41 | 平均流量滤波时间 | 整数 | 单位：s,取值[0-9]，实际表示[1-10]<br />推荐值[0，1，4，9] | WR |

### 5.3 错误响应

> 如果设备不能正确执行上位机命令，则会返回如下格式信息：

| 地址  | 功能码       | CODE | CRC16 (L) | CRC16 (H) |
|-------|--------------|------|----------|-----------|
| ADDR  | COM + 80H    | xx   |CRC16 (L) | CRC16 (H) |

> COM 为接收到的功能码。
> CODE xx 的含义：
> - `01` – 功能码错误
> - `03` – 数据错误

## 6. 故障代码对应说明

| 错误代码 | 错误说明 |
| ---- | ---- |
| E0000**X** | EEPROM 驱动错误 |
| E000**X**0 | ADX 驱动错误 |
| E00**X**00 | LoRa 模块错误 |
| E0**X**000 |  |
| E**X**0000 | RTC 模块错误|

## 7. 调试模式下显示说明

|显示项目 | 说明 | 计算公式 |
| ---- | ---- | ---- |
| 原始频率 \(f\) | 设备从传感器采集到的频率 | - |
| 运行时的仪表系数 \(k\) | 通过设置流量算法选项计算得到 | - |
| 补偿后的频率 \(f_c\) | 根据原始频率和仪表系数等计算得出的补偿值 | \(f_c = \frac{f}{k} \times k_a\) |
| 累计频率值 | 累计的原始频率值 |  |

> $k_a$ 为设置的平均仪表系数。

## 8. 复位代码说明

|复位原因 |代码 |
| ---- | ---- |
| 上电 | 0 |
| 低电压检测（LVD） | 1 |
| 锁死（Lockup） | 2 |
| 复位引脚（ResetPin） | 3 |
| 看门狗定时器（WDT） | 4 |
| 软件复位 | 5 |
| 其他 | E |
